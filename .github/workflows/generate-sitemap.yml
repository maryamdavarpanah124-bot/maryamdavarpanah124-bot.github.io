name: Generate sitemap

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-sitemap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate sitemap.xml
        run: |
          python - <<'PY'
          import os, datetime
          BASE_URL = "https://maryamdavarpanah124-bot.github.io"
          today = datetime.date.today().isoformat()
          pages = []
          for root, dirs, files in os.walk("."):
              for f in files:
                  if f.endswith(".html"):
                      path = os.path.join(root, f).replace("\\", "/")
                      web_path = path.lstrip("./")
                      pages.append(web_path)
          lines = []
          lines.append('<?xml version="1.0" encoding="UTF-8"?>')
          lines.append('<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">')
          lines.append(f'  <url><loc>{BASE_URL}</loc><lastmod>{today}</lastmod><priority>1.0</priority></url>')
          for p in sorted(pages):
              if p == "index.html":
                  continue
              name = p.lower()
              if any(k in name for k in ["general", "math", "analysis", "differential", "trigonometry", "laplace", "sequence", "vector", "matrix", "derivative"]):
                  priority = "0.8"
              elif any(k in name for k in ["partial-derivative", "complex", "integrating-factor"]):
                  priority = "0.6"
              elif any(k in name for k in ["about", "reviews", "articles"]):
                  priority = "0.7"
              else:
                  priority = "0.7"
              lines.append(f'  <url><loc>{BASE_URL}/{p}</loc><lastmod>{today}</lastmod><priority>{priority}</priority></url>')
          lines.append('</urlset>')
          with open("sitemap.xml", "w", encoding="utf-8") as f:
              f.write("\n".join(lines))
          PY

      - name: Auto-commit sitemap.xml
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-generate sitemap.xml"
          file_pattern: sitemap.xml
